# Nama workflow yang akan muncul di tab Actions GitHub
name: CI/CD Pipeline Mendalami Rasa

# Pemicu: Workflow ini akan berjalan setiap kali ada push ke branch 'main'
on:
  push:
    branches: [ "main" ]

# Daftar pekerjaan (jobs) yang akan dijalankan
jobs:
  # Nama job, bisa apa saja, misalnya 'build-and-deploy' atau 'test-and-publish'
  build-and-push:
    # Menentukan mesin virtual yang akan digunakan, 'ubuntu-latest' adalah pilihan umum
    runs-on: ubuntu-latest

    # Langkah-langkah (steps) yang akan dieksekusi secara berurutan
    steps:
      # Langkah 1: Mengunduh kode dari repositori Anda ke mesin virtual
      - name: Checkout repository
        uses: actions/checkout@v3

      # Langkah 2: Menyiapkan lingkungan PHP menggunakan action populer
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          # Pastikan versi ini sesuai dengan yang dibutuhkan oleh dependensi Anda (misal: 8.2)
          php-version: '8.2'
          # Mengaktifkan caching untuk Composer agar instalasi lebih cepat di run berikutnya
          tools: composer:v2

      # Langkah 3: Menginstal dependensi PHP yang tercatat di composer.json/composer.lock
      - name: Install dependencies
        # 'composer install' lebih cepat karena menggunakan lock file.
        # '--prefer-dist' mengunduh versi zip, lebih cepat.
        # '--no-progress' menonaktifkan progress bar yang tidak perlu di log CI.
        run: composer install --prefer-dist --no-progress

      # Langkah 4: Memberikan izin eksekusi pada file Pest
      # Diperlukan karena izin file kadang hilang saat checkout dari Git
      - name: Make pest executable
        run: chmod +x ./vendor/bin/pest

      # Langkah 5: Menjalankan unit test dengan Pest
      - name: Run unit tests
        run: ./vendor/bin/pest

      # Langkah 6 (OPSIONAL DEBUG): Cetak username untuk memastikan secret terbaca
      # Hapus atau beri komentar pada langkah ini setelah masalah teratasi
      - name: Print Docker Hub username for debugging
        run: echo "Attempting to log in as user ${{ secrets.DOCKERHUB_USERNAME }}"

      # Langkah 7: Login ke Docker Hub menggunakan secrets
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          # Mengambil username dari GitHub Secrets
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          # Mengambil token dari GitHub Secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Langkah 8: Membangun image Docker dan mendorongnya ke Docker Hub
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          # 'context: .' berarti Dockerfile ada di root folder proyek
          context: .
          # 'push: true' berarti setelah build, langsung push ke registry
          push: true
          # 'tags:' adalah nama untuk image Anda. Format: <username>/<nama-image>:<tag>
          # 'latest' adalah tag umum untuk versi terkini.
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/uas-pkpl-mendalami-rasa:latest
